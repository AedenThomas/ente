name: "Windows Installer Signing Test (auth)"

on:
    workflow_dispatch: # Allow manually running the action

permissions:
    contents: write

jobs:
    sign-windows-installer:
        runs-on: windows-latest
        environment: "auth-win-build"

        steps:
            - name: Create artifacts directory
              run: mkdir -p artifacts

            - name: Download Windows installer
              run: |
                curl -L https://github.com/ente-io/ente/releases/download/auth-v4.3.5/ente-auth-v4.3.5-installer.exe -o artifacts/unsigned-installer.exe

            - name: Sign installer with Trusted Signing
              uses: azure/trusted-signing-action@v0
              with:
                azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
                azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
                endpoint: ${{ secrets.AZURE_ENDPOINT }}
                trusted-signing-account-name: ${{ secrets.AZURE_CODE_SIGNING_NAME }}
                certificate-profile-name: ${{ secrets.AZURE_CERT_PROFILE_NAME }}
                files: |
                    ${{ github.workspace }}/artifacts/unsigned-installer.exe
                file-digest: SHA256
                timestamp-rfc3161: http://timestamp.acs.microsoft.com
                timestamp-digest: SHA256
                
            - name: Verify signing
              run: |
                powershell -Command "Get-AuthenticodeSignature artifacts/unsigned-installer.exe | Format-List"